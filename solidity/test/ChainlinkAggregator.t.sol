// SPDX-License-Identifier: Apache-2.0
pragma solidity ^0.8.13;

import "forge-std/Test.sol";

import {ChainlinkAggregator} from "../contracts/middleware/ChainlinkAggregator.sol";
import {MockHyperlaneEnvironment} from "../contracts/mock/MockHyperlaneEnvironment.sol";
import {AggregatorV3Interface} from "../contracts/interfaces/chainlink/AggregatorV3Interface.sol";

import {TypeCasts} from "../contracts/libs/TypeCasts.sol";

contract ChainlinkAggregatorTest is Test {
    event AnswerUpdated(
        int256 indexed current,
        uint256 indexed roundId,
        uint256 updatedAt
    );

    int192 MAX_INT192 = 95780971304118053647396689196894323976171195136475135;

    MockHyperlaneEnvironment testEnvironment;
    ChainlinkAggregator aggregator;

    uint32 originDomain = 123;
    uint32 destinationDomain = 321;

    bytes validReport = (
        hex"000000000000000000000008afbcf24ae1efc261fa46eec781904900008f460511161b12151006090a0b010f1c1e04130c050e0d08001419071d02031a1718000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000001f00000000000000000000000000000000000000000000000000000028073b04000000000000000000000000000000000000000000000000000000002807cc7ef80000000000000000000000000000000000000000000000000000002808016140000000000000000000000000000000000000000000000000000000280801614000000000000000000000000000000000000000000000000000000028082786e000000000000000000000000000000000000000000000000000000028082ef9200000000000000000000000000000000000000000000000000000002808554da0000000000000000000000000000000000000000000000000000000280857708000000000000000000000000000000000000000000000000000000028091409c000000000000000000000000000000000000000000000000000000028091409c000000000000000000000000000000000000000000000000000000028091409c000000000000000000000000000000000000000000000000000000028095e50fc00000000000000000000000000000000000000000000000000000028096e9a5400000000000000000000000000000000000000000000000000000028096e9a5400000000000000000000000000000000000000000000000000000028096f974000000000000000000000000000000000000000000000000000000028096f974000000000000000000000000000000000000000000000000000000028096f97400000000000000000000000000000000000000000000000000000002809aeabb00000000000000000000000000000000000000000000000000000002809b33ba8000000000000000000000000000000000000000000000000000000280b59bed4000000000000000000000000000000000000000000000000000000280baa4e50000000000000000000000000000000000000000000000000000000280c0a52b6000000000000000000000000000000000000000000000000000000280c0a52b6000000000000000000000000000000000000000000000000000000280c0a52b6000000000000000000000000000000000000000000000000000000280c0a52b6000000000000000000000000000000000000000000000000000000280c58f1bb000000000000000000000000000000000000000000000000000000280cdfded0000000000000000000000000000000000000000000000000000000280d400030000000000000000000000000000000000000000000000000000000280e9c5be00000000000000000000000000000000000000000000000000000002811fbb380000000000000000000000000000000000000000000000000000000281a692430"
    );

    address[] _signers = [
        0x080D263FAA8CBd848f0b9B24B40e1f23EA06b3A3,
        0xCdEf689d3098A796F840A26f383CE19F4f023B5B,
        0xb7bEA3A5d410F7c4eC2aa446ae4236F6Eed6b16A,
        0x5ba2D2B875626901fed647411AD08009b1ee35e2,
        0x21389cBcdb25c8859c704BD8Cd7252902384FceF,
        0x03A67cD8467642a03d5ebd67F97157931D94fA32,
        0x3650Da40Fe97A93bfC2623E0DcA3899a91Eca0e2,
        0x1F31c45AE0605690D63D26d7CdA4035c3668D473,
        0xCc1b49B86F79C7E50E294D3e3734fe94DB9A42F0,
        0xA4EBE1e06dd0bf674B0757cd20b97Ee16b00aF1B,
        0x8d4AE8b06701f53f7a34421461441E4492E1C578,
        0x5007b477F939646b4E4416AFcEf6b00567F5F078,
        0x55048BC9f3a3f373031fB32C0D0d5C1Bc6E10B3b,
        0x8316e3Eb7eccfCAF0c1967903CcA8ECda3dF37E0,
        0x503bd542a29F089319855cd9F6F6F937C7Be87c7,
        0xbd34530f411130fd7aCB88b8251009A0829379aA,
        0x54103390874885e164d69bf08B6db480E5E8fE5d,
        0xC01465eBA4FA3A72309374bb67149A8FD14Cb687,
        0xAF447dA1E8c277C41983B1732BECF39129BE5CA6,
        0xbe15B23E9F03e3Bb44c5E35549354649fb25b87B,
        0x1E15545b23B831fD39e1d9579427DeA61425DD47,
        0xD1C8b1e58C1186597D1897054b738c551ec74BD4,
        0x8EB664cD767f12507E7e3864Ba5B7E925090A0E5,
        0x656Fc633eb33cF5daD0bCEa0E42cde85fb7A4Ab8,
        0x076b12D219a32613cd370eA9649a860114D3015e,
        0x0ac6c28B582016A55f6d4e3aC77b64749568Ffe1,
        0xD3b9610534994aAb2777D8Af6C41d1e54F2ef33f,
        0xbeB19b5EC84DdC9426d84e5cE7403AFB7BB56700,
        0xd54DDB3A256a40061C41Eb6ADF4f412ca8e17c25,
        0xdb69C372B30D7A663BDE45d31a4886385F50Ea51,
        0x67a95e050d2E4200808A488628d55269dDeFC455
    ];
    address[] _transmitters = [
        0xCF4Be57aA078Dc7568C631BE7A73adc1cdA992F8,
        0x686beC83b59F8b23A6129f03550A3Aad245a543C,
        0x982fa4d5F5C8C0063493AbE58967cA3B7639F10F,
        0x8b1d49a93A84B5dA0917a1ed42D8a3E191C28524,
        0x8F3Ab0e87B70a57bD4980111a99a1b2c4b8334F4,
        0x7663C5790E1eBf04197245d541279D13f3c2f362,
        0x61317C73d0225b2E37140fb9664d607B450613C6,
        0x2a4a7afA40a9D03B425752fb4cFd5f0FF5b3964C,
        0xb976d01275B809333E3EfD76D1d31fE9264466D0,
        0xf34aC04a28F7CB5324A167C96B24ADE9c742B44f,
        0x57CD4848b12469618b689163f507817940AccA02,
        0xDbfea8D5822141c13f92CaA06EB94d0F3d67C243,
        0x5a8216a9c47ee2E8Df1c874252fDEe467215C25b,
        0xFa0E4F48a369BB3eCBCEe0B5119379EA8D1bcF29,
        0xEdBED9F5dEA03dD0ec484577C41502af68B7c46a,
        0x3C4ad65F5b4884397e1F09596c7ac7F8F95b3fF3,
        0x632f869a26Ab4DA58e2Da476EE74800f2BAE060A,
        0x218B5a7861dBf368D09A84E0dBfF6C6DDbf99DB8,
        0x0312EA121df0a323fF535B753172736cc9d53d13,
        0x5565b5362FF9f468bA2f144f38b87187C9a010A8,
        0x7BFb89db2d7217c57C3Ad3d4B55826eFD17dC2e9,
        0xc74cE67BfC623c803D48AFc74a09A6FF6b599003,
        0xcC29be4Ca92D4Ecc43C8451fBA94C200B83991f6,
        0xf16e77a989529AA4C58318acEe8A1548Df3fcCc1,
        0x9cFAb1513FFA293E7023159B3C7A4C984B6a3480,
        0xC4b732Fd121F2f3783A9Ac2a6C62fD535FD13FdA,
        0x43793ee58E0a3D920e3e4a115A9FA07dc4B09715,
        0xF07131F578a5F708AE2CCB9faF98458099E0FFB4,
        0xddEB598fe902A13Cc523aaff5240e9988eDCE170,
        0x5a6fCc02D8c50eA58a22115A7c4608b723030016,
        0xDdE59ceeC7A2cC8B2bD78199877BA22018966813
    ];
    uint8 _threshold = 10;
    uint64 _encodedConfigVersion = 1;
    bytes _encoded =
        hex"00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000826299e0000000000000000000000000000000000000000000000000000000003f5476a0000000000000000000000000000000000000000000000000000000006fc23ac0000000000000000000000000000000000000000000000000000000002cb4178000000000000000000000000000000000000000000000000000000034630b8a00000000000000000000000000000000000000000000000000000000000004c4b400000000000000000000000000000000000000000000000000000000df847580000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000009800000000000000000000000000000000000000000000000000000000000001020000000000000000000000000000000000000000000000000000000000000001f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001f23592f9c86d4ed6f10d07169e32a8896ce4cb1374b2e4d09f388699a5a4ed061ae4ef5f5514548964e40a8ba493d2e4aa37e87699c76d7278cda9ed4ca32ca2e776a8b73cbdcf0b1292077ce72e84957e82c8c1911aee48bdae8ddf8edd46e617bdfe5913178b324502d1cfbdb7c8f3545b1145dbf9c66778b3626ca2b1401123cd5194c3a395f30132c7c239b6255fa617a19c7e7dfc55ba3b0d84b94a1852ad8baba7dbd37a53c8456d72e974aee0ab6373b7ff34f4daa67e895bb90ac6e9c887a76356bc97b88bb15b5c1d9750290f0324cd62e5046743bbabc900cdcc2d46947701afb054fa7d4313aa935145354c1491bb035ebe128994dada3679aebd93f6ed381d973b5d843882c496de2faf4f0f2943240c7da500b6126a2b9fa6c1da6f78d3d940ed1eee3391a8955b723ac5f1a65c6ef0179a762034f55fd9a0aecda7f7b87602198cb9931dac86e2d63cb48b1408257d128201ba533aebb75a1b0ae90be70e97fab367a0a7444bd1157f2ca81e328e854553f2cf239419c96ef0d85bc5950f1bef38bf8fb19df44d23a6d8e65e22c3ba2a544cd1f8e3f19c4d86eb12cc0640aa6c047c51ce0ab4ba5a56e0462745ea92b3e5e7e2339886611e6d12ca5437316b11124e0375a6af5c00c47e1a519a430d3bea43821ec5c2f7d413443a310e03ed3c99b01b43a6b6e6ad1ea73051b15a42ac3f44f18dcd1f1c1852f90c0d6ce17557910678f2cd2feb8e099aa6a5237b1388d866b53c233dc4dc1ef09f2d0a6c4cd968fd18042bb6451f2574fea0a875695fe1fa9529dbea5dd823571e872439ab1f03cf074fbd35cbdc3565664aaf6aca31b86f904da050cead6ff3f291abc8bd8467ca0f5354ab6ac61c7b996cd4195f7c4fb3ba70950830d8df9b490fcc4c4399222102251a14699dae7676ab2ba45bf3cbce854b502528fd524268e5bb8f07b165ec9cb6f219eb16eee60def6a0225d4f4028f3d25f6e9ba9fe0dd789d4e970d0f999855f943b44d3fb497d6fe365afca17f6d35b868e516875ba7299157b559ca4a68dc2ebf4769ce74e05ecbd18039199415e804d87c444110354bdb5cc16031605b79794bcfe1e839e9a36b9d0685a34164e6f5c93702e20e91a3af408c56c32b315ba9ff6839625ca6d847bb77cbedab6efc011a926405c784569f6776346d0d1c7efa85455c2fc41fbb0499e46a022a00b18a881dc33d68055ee8f6186049307d784c3b23e4a8bb5afef47f79714b0bc34243d52ca08b3753a9d2674e251ed9bfd415bf984de11f0b6a5cf6cc12ee30fc76d715338ad88cf360f6fb464a82635af930578bfa602973113683e0f630bba79c5f695bfef43fc6b87a6bc917e0c4f8088105e7fa28cbbf70dd44f9fd9e45c5c6c4e7b1a5cb3000000000000000000000000000000000000000000000000000000000000066a313244334b6f6f574a47463953425932484735544c48664a724d7638626f6d3844476a4c32314d417a695236744261367a316a722c313244334b6f6f574134635650316a536d734d627979634b3947473932547a653353686d384e6d3870316e42704c57536f57766e2c313244334b6f6f574b367845566235384877796647544c4c65737232774667644171644e7471684d5a43435670625755374872562c313244334b6f6f574d5a78616b3574507077726b75374861474a485879315a625a6e6d7a62426970597942314e726572776e54422c313244334b6f6f5747345a43376a386159637137684178564a5a756675656b513870534c743944684d4651315339733879346a582c313244334b6f6f57536361344751474e5a7931654e64654e7673693745676861586d716f53534c33334e7451356e7962466562702c313244334b6f6f57414e674b376574716177674b64584d61374d446e6d46566e5447446554414271736e6e6b5756446b544161522c313244334b6f6f57506235474d4e6e504b426d7770445a616e46667058366a553552704e664a593343396a6d773861427a7633442c313244334b6f6f574761566252356378546e384b656355766a78574d505a7233415642333556784c4675424a43363376764a4d772c313244334b6f6f574e427047466e5346326d6d5a3877654c56337334487435564756346a756f4b733333577a4b6351334b39704e2c313244334b6f6f574b4b71374e714d6946555833464134525972736372396e316457786f555266464656504d74564c63577356732c313244334b6f6f5748765435536764597437465353454e4a47414753395a4a6d316a565137486d534e4e573265587566316f33312c313244334b6f6f57534c366276756a4142704e61623934664d527577446d617465503975426d685144693669556b6d326f516f522c313244334b6f6f5751387331734a6555554b665a5377573957656a623561776b313374524d724e62464d7558486a654e4d7133482c313244334b6f6f5747435332686473466d633263475478596247734e6f6863756d444c31706b38676d794855657633324b6654512c313244334b6f6f575246754855446d37696162507a6e6d37797576736776594e717a4a7a69444d4a527247426d6e5631786d58322c313244334b6f6f574d4c416b375a73547364344d50596457654c63724c3862747555713737374d5371383852476141584a4e474e2c313244334b6f6f57436571324e347442536d7952426461536e6a6a6f7859556a346850734e4b617567773647516477696a616f592c313244334b6f6f574b37637a4e785767547954323374736f62476b4d7a646477764b775072377a6f547a366e754c6773695763792c313244334b6f6f57456d70564d685a5273314d4532484d6a6878453450355a616a4c7644677579414b636f3954536679744d58432c313244334b6f6f57413250716f563733596e34674c774b5a7466376b5a7441573855706954506a45484844595a334862735843382c313244334b6f6f5753704c6b7544396234327972466f70724351756a705734676b7254414753574e3745666e756d68556b764b422c313244334b6f6f574878666b636e44653154615846684868747a4233544663716536736b374b4e516573776337434644786832692c313244334b6f6f574147734a5857487776535162426f5738467a4170314d714d45514b36644e75757479556d46576657316f59752c313244334b6f6f5748586b3841446e487879324a55797179736244486a5a574c38536333776f654441716b7275744a56425762592c313244334b6f6f574771705975695534756d34384358795a6b6a736f664458524d5166736f34733452584848785a756a444559382c313244334b6f6f5743686954664e325454334751646e674b5945326b53526a76674a3972466e4a7a4c7a664265785133546f4c6a2c313244334b6f6f574e427867716268426969777a32637031727755486a4d517563323669536a7444657052363344674a6b42744a2c313244334b6f6f57505270553564384e7545755579525532745366473248465a5a544439506d484c676351426a69784d4b7661472c313244334b6f6f574a335365325a68724c73767562714278625373523466554b6861674b376955457a75575758624776416959742c313244334b6f6f574131513662634c51594b57794b7965727742547857735958474e6e7a366b4c6377596f6b6a44476a69726262000000000000000000000000000000000000000000005e4e947ed30fc6fc0ee5576d6c37a65bfd05a285eaac0f7eb257b048e20d905535689c55eebb80d2aa391842f921322edc9975a8318017a9466f9902792dcdb00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000001f4a95c83ac4d11884239be6460ae3578700000000000000000000000000000000ab77e354f134b99de7435ede3a6e223500000000000000000000000000000000f226886aab1b9f107f5bea48c678abce00000000000000000000000000000000502c31ac0297931f8e0bf569640d89ab0000000000000000000000000000000033681a8692022f2932f17d91dc3dac5d00000000000000000000000000000000714afbfff1b4ce5253c2217b183819a4000000000000000000000000000000002525f99f6f0e5d6d18bf5158aaa48df800000000000000000000000000000000a110b7a877eb51ee99bf796c880766f6000000000000000000000000000000009605954b3926ad95f1197933a66b53c6000000000000000000000000000000003da2068af96081593cf86674e594216400000000000000000000000000000000ea225a7659db2a18213e2287a7ad95ea0000000000000000000000000000000099f90fb3fa3928b0bca936324cb43146000000000000000000000000000000003965edc070d209ed08c9edbfe9c6faae0000000000000000000000000000000004514d97ee07e05a78e962fd29cdb3ce00000000000000000000000000000000d6d66a7cfe12e674f4b00f5a1ba37028000000000000000000000000000000001e4665cb57f11395e1c69344a5c07f5100000000000000000000000000000000f6c8af5c64dc4dcd185eccf865d0fee700000000000000000000000000000000145d86e6e9bd5904df1497b75eb0c692000000000000000000000000000000006e8bba0def5ffe678f781e3b554a662f0000000000000000000000000000000011dbcda7c16a79902b4b7187c2befdff00000000000000000000000000000000fd8ba0f839b7b5ef39d51d1d476e4e51000000000000000000000000000000009e4868de1dacecc3668004f6ed7728ed000000000000000000000000000000003a5e4c5b482824835f6a7bc6d366ee7800000000000000000000000000000000e2e13b0cf57562e2cc3f2a72759f6ed7000000000000000000000000000000008132957ec3aa49f8337e58a18655ac8e00000000000000000000000000000000166737b520b75101c03c9023763eefb1000000000000000000000000000000004fde1598d6fa8313b1fc72503966329900000000000000000000000000000000b8343bde509aa6319b4c9df77ee8d71b000000000000000000000000000000006f54b53c799a514791a1e4d35ee71ffc000000000000000000000000000000008da8a65e884c7bb3865b797ef36c661600000000000000000000000000000000a4a7f8a60089d00751d85c23db0fefd300000000000000000000000000000000";

    function setUp() public {
        aggregator = new ChainlinkAggregator(1, MAX_INT192, 8, "");

        testEnvironment = new MockHyperlaneEnvironment(
            originDomain,
            destinationDomain
        );

        aggregator.initialize(
            address(testEnvironment.mailboxes(destinationDomain)),
            address(testEnvironment.igps(destinationDomain)),
            address(testEnvironment.isms(destinationDomain)),
            address(this)
        );

        aggregator.setConfig(
            _signers,
            _transmitters,
            _threshold,
            _encodedConfigVersion,
            _encoded
        );
    }

    function testOnlyMailboxCanCallHandle() public {
        vm.expectRevert(bytes("!mailbox"));
        aggregator.handle(0, "", "");
    }

    function testHandleValidMessage() public {
        testEnvironment.mailboxes(originDomain).dispatch(
            destinationDomain,
            TypeCasts.addressToBytes32(address(aggregator)),
            validReport
        );

        vm.expectEmit(true, false, false, true);
        emit AnswerUpdated(171957000000, 1, 1);
        testEnvironment.processNextPendingMessage();

        (, int256 answer, , , ) = aggregator.latestRoundData();
        assertEq(answer, 171957000000);
    }
}
